name: Cold Email Sync

# Automated pipeline to sync leads from BigQuery to Instantly.ai

on:
  schedule:
    # Run every 30 minutes during business hours (9 AM - 6 PM EST, Mon-Fri)
    - cron: '*/30 13-23 * * 1-5'  # UTC times for EST business hours
    # Also run every 2 hours on weekends (lighter schedule)  
    - cron: '0 */2 * * 0,6'
  workflow_dispatch:  # Allow manual triggers
    inputs:
      dry_run:
        description: 'Run in dry mode (no actual changes)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      target_leads:
        description: 'Number of new leads to process'
        required: false
        default: '100'

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Create initial log file
        run: |
          echo "GitHub Actions workflow started at $(date)" > workflow.log
          echo "Runner: ${{ runner.os }}" >> workflow.log
          echo "GitHub ref: ${{ github.ref }}" >> workflow.log
          ls -la >> workflow.log 2>&1
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies..." | tee -a workflow.log
          pip install --upgrade pip 2>&1 | tee -a workflow.log
          
          # Install from requirements.txt to ensure all dependencies are included
          if [ -f requirements.txt ]; then
            echo "ðŸ“¦ Installing from requirements.txt..." | tee -a workflow.log
            pip install -r requirements.txt 2>&1 | tee -a workflow.log
          else
            echo "âš ï¸ requirements.txt not found, installing minimal dependencies..." | tee -a workflow.log
            pip install google-cloud-bigquery requests tenacity 2>&1 | tee -a workflow.log
          fi
          
          echo "âœ… Dependencies installed" | tee -a workflow.log
      
      - name: Create credentials file
        env:
          BIGQUERY_CREDS: ${{ secrets.BIGQUERY_CREDENTIALS_JSON }}
        run: |
          # Create directory structure
          mkdir -p config/secrets
          
          # Debug: Check if secrets are available (without exposing them)
          echo "ðŸ” Checking secrets availability..."
          if [ -n "${BIGQUERY_CREDS}" ]; then
            echo "âœ… BIGQUERY_CREDENTIALS_JSON secret is available (${#BIGQUERY_CREDS} chars)"
          else
            echo "âŒ ERROR: BIGQUERY_CREDENTIALS_JSON secret not set"
            exit 1
          fi
          
          if [ -n "${{ secrets.INSTANTLY_API_KEY }}" ]; then
            echo "âœ… INSTANTLY_API_KEY secret is available" 
          else
            echo "âŒ ERROR: INSTANTLY_API_KEY secret not set"
            exit 1
          fi
          
          # Create credentials file using environment variable
          echo "ðŸ“ Creating credentials file..."
          echo "${BIGQUERY_CREDS}" > config/secrets/bigquery-credentials.json
          chmod 600 config/secrets/bigquery-credentials.json
          
          # Verify file was created
          if [ -f "config/secrets/bigquery-credentials.json" ]; then
            file_size=$(stat -c%s "config/secrets/bigquery-credentials.json" 2>/dev/null || stat -f%z "config/secrets/bigquery-credentials.json" 2>/dev/null || echo "unknown")
            echo "âœ… Credentials file created successfully ($file_size bytes)"
            
            # Validate JSON format
            if python -m json.tool config/secrets/bigquery-credentials.json > /dev/null 2>&1; then
              echo "âœ… Credentials file is valid JSON"
            else
              echo "âŒ ERROR: Credentials file is not valid JSON"
              exit 1
            fi
          else
            echo "âŒ ERROR: Failed to create credentials file"
            exit 1
          fi
      
      - name: Debug Python environment
        run: |
          echo "ðŸ Python version:"
          python --version
          echo ""
          echo "ðŸ“¦ Installed packages:"
          pip list
          echo ""
          echo "ðŸ“ Current directory contents:"
          ls -la
          echo ""
          echo "ðŸ“‚ Config directory:"
          ls -la config/secrets/ || echo "config/secrets not found"
          
      - name: Validate environment
        run: |
          echo "ðŸ” Validating GitHub Actions environment..."
          python validate_environment.py || {
            echo "âŒ Environment validation failed with exit code $?"
            exit 1
          }
          
      - name: Test imports
        run: |
          echo "ðŸ§ª Testing Python imports..."
          python -c "import os; print('âœ… os module OK')"
          python -c "import logging; print('âœ… logging module OK')"
          python -c "from google.cloud import bigquery; print('âœ… google.cloud.bigquery OK')" || echo "âŒ Failed to import bigquery"
          python -c "import requests; print('âœ… requests OK')" || echo "âŒ Failed to import requests"
          python -c "import tenacity; print('âœ… tenacity OK')" || echo "âŒ Failed to import tenacity"
          
      - name: Run minimal test
        run: |
          echo "ðŸ§ª Running minimal test..."
          python test_minimal.py || {
            echo "âŒ Minimal test failed"
            echo "ðŸ“„ Test log contents:"
            cat test.log || echo "No test.log file found"
            exit 1
          }
          
      - name: Run sync
        env:
          # Required secrets
          INSTANTLY_API_KEY: ${{ secrets.INSTANTLY_API_KEY }}
          
          # Configuration
          TARGET_NEW_LEADS_PER_RUN: ${{ github.event.inputs.target_leads || '100' }}
          INSTANTLY_CAP_GUARD: '24000'
          BATCH_SIZE: '50'  # Conservative for startup
          BATCH_SLEEP_SECONDS: '10'
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          
          # Python path
          PYTHONPATH: .
        
        run: |
          echo "ðŸš€ Starting Cold Email Sync" | tee -a workflow.log
          echo "Target leads: $TARGET_NEW_LEADS_PER_RUN" | tee -a workflow.log
          echo "Dry run: $DRY_RUN" | tee -a workflow.log
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" | tee -a workflow.log
          echo "" | tee -a workflow.log
          
          # Ensure we have the API key
          if [ -z "$INSTANTLY_API_KEY" ]; then
            echo "âŒ INSTANTLY_API_KEY not available in environment" | tee -a workflow.log
            exit 1
          fi
          
          echo "âœ… Environment variables validated" | tee -a workflow.log
          
          # Run the sync script with full output capture
          echo "ðŸ“ Running sync_once.py..." | tee -a workflow.log
          python sync_once.py 2>&1 | tee -a workflow.log || {
            exit_code=$?
            echo "âŒ sync_once.py failed with exit code $exit_code" | tee -a workflow.log
            
            # If sync fails, try debug script
            echo "ðŸ” Running debug script..." | tee -a workflow.log
            python debug_sync.py 2>&1 | tee -a workflow.log || echo "Debug script also failed" | tee -a workflow.log
            
            # List any log files created
            echo "ðŸ“„ Log files in directory:" | tee -a workflow.log
            ls -la *.log 2>&1 | tee -a workflow.log || echo "No .log files found" | tee -a workflow.log
            
            exit $exit_code
          }
      
      - name: Cleanup credentials
        if: always()
        run: |
          rm -f config/secrets/bigquery-credentials.json
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-logs-${{ github.run_number }}
          path: |
            *.log
            cold-email-sync.log
            test.log
            workflow.log
          if-no-files-found: warn
          retention-days: 7